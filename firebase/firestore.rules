// firebase/firestore.rules
// Firebase Security Rules enforcing UID Centrality (Specification I.1-I.4, II.1-II.3)
// This ensures that only the authenticated user can access/modify their own data

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // === USERS COLLECTION: UID CENTRALITY (Specification I.2) ===
    // Document ID MUST be Firebase Auth UID
    match /users/{userId} {
      // Public read access - users can view profiles for friend requests, etc.
      allow read: if true;
      
      // CRITICAL: User can only write/update their own profile
      // The path ID (userId) MUST match their Auth UID
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // Subcollection: friends (Specification II.1-II.2)
      match /friends/{friendId} {
        // Users can read their own friends list
        allow read: if request.auth != null && request.auth.uid == userId;
        
        // Users can only modify their own friends subcollection
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // === FRIEND REQUESTS COLLECTION (Specification II.1-II.2) ===
    match /friend_requests/{requestId} {
      // Allow authenticated users to read friend requests they are involved in
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.fromUserId || 
        request.auth.uid == resource.data.toUserId
      );
      
      // Allow authenticated users to create friend requests
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.fromUserId;
      
      // Allow the recipient to delete (accept/reject) their incoming requests
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.toUserId;
      
      // Allow the sender to update their own sent requests (if needed)
      allow update: if request.auth != null && 
        request.auth.uid == resource.data.fromUserId;
    }

    // === NOTIFICATIONS COLLECTION (Specification II.2) ===
    match /notifications/{userId} {
      // Users can only access their own notifications
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Subcollection: individual notifications
      match /notifications/{notificationId} {
        // Users can only access their own notifications
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // === GAME ROOMS COLLECTION (Multiplayer) ===
    match /game_rooms/{roomId} {
      // Allow read access to active game rooms for joining
      allow read: if true;
      
      // Allow authenticated users to create rooms
      allow create: if request.auth != null;
      
      // Allow authenticated users to update rooms they are part of
      allow update: if request.auth != null && (
        request.resource.data.hostId == request.auth.uid ||
        (request.auth.uid in request.resource.data.players)
      );
      
      // Allow authenticated users to delete rooms they created
      allow delete: if request.auth != null && resource.data.hostId == request.auth.uid;
    }

    // === EMAIL OTP CODES COLLECTION (Temporary verification codes) ===
    match /email_otp_codes/{otpCodeId} {
      // Allow public read access for code verification (no auth required for security)
      // Codes expire automatically and contain no sensitive user data
      allow read: if request.time < timestamp.date(resource.data.expiresAt);
      
      // Allow creation of new OTP codes (for registration and password reset)
      allow create: if request.auth != null && 
        request.resource.data.email is string &&
        request.resource.data.code is string &&
        request.resource.data.code.matches('^[0-9]{6}

    // === ADMIN ACCESS (Optional - restrict to specific users) ===
    match /admin/{documentId} {
      // Only allow access to authenticated admin users
      // This would require additional admin role checking
      allow read, write: if request.auth != null && 
        request.auth.token.admin == true;
    }

    // === SECURITY RULES FOR PREVENTING UNAUTHORIZED ACCESS ===
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}) && // 6-digit numeric code
        request.resource.data.createdAt is timestamp &&
        request.resource.data.expiresAt is timestamp &&
        request.resource.data.expiresAt > request.time &&
        request.resource.data.status == 'active';
      
      // Allow update for code status changes (used, expired)
      allow update: if request.auth != null &&
        request.resource.data.email == resource.data.email &&
        request.resource.data.code == resource.data.code &&
        (
          (request.resource.data.status == 'used' && !resource.data.usedAt) ||
          (request.resource.data.status == 'expired' && request.time > resource.data.expiresAt)
        );
      
      // Allow delete for cleanup operations (optional)
      allow delete: if request.auth != null;
    }

    // === EMAIL USAGE COLLECTION (Email usage tracking for limitation) ===
    match /email_usage/{emailHash} {
      // Allow read access to authenticated users for email validation
      allow read: if request.auth != null;
      
      // Allow authenticated users to create email usage records during registration
      allow create: if request.auth != null && 
        request.resource.data.email is string &&
        request.resource.data.usageCount is int &&
        request.resource.data.usageCount >= 1 &&
        request.resource.data.usageCount <= 2;
      
      // Allow authenticated users to update email usage records
      allow update: if request.auth != null &&
        request.resource.data.email == resource.data.email &&
        request.resource.data.usageCount == resource.data.usageCount + 1 &&
        request.resource.data.usageCount <= 2;
      
      // Allow read access to scores for leaderboard
      allow read: if true;
      
      // Allow authenticated users to write their scores
      allow create: if request.auth != null;
      allow update, delete: if false; // Prevent score modification after creation
    }

    // === ADMIN ACCESS (Optional - restrict to specific users) ===
    match /admin/{documentId} {
      // Only allow access to authenticated admin users
      // This would require additional admin role checking
      allow read, write: if request.auth != null && 
        request.auth.token.admin == true;
    }

    // === SECURITY RULES FOR PREVENTING UNAUTHORIZED ACCESS ===
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}